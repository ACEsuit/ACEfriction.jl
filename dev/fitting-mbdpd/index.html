<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Fitting a Dissipative Particle Dynamics Friction Model · ACEfriction.jl</title><meta name="title" content="Fitting a Dissipative Particle Dynamics Friction Model · ACEfriction.jl"/><meta property="og:title" content="Fitting a Dissipative Particle Dynamics Friction Model · ACEfriction.jl"/><meta property="twitter:title" content="Fitting a Dissipative Particle Dynamics Friction Model · ACEfriction.jl"/><meta name="description" content="Documentation for ACEfriction.jl."/><meta property="og:description" content="Documentation for ACEfriction.jl."/><meta property="twitter:description" content="Documentation for ACEfriction.jl."/><meta property="og:url" content="https://ACEsuit.github.io/ACEfriction.jl/fitting-mbdpd/"/><meta property="twitter:url" content="https://ACEsuit.github.io/ACEfriction.jl/fitting-mbdpd/"/><link rel="canonical" href="https://ACEsuit.github.io/ACEfriction.jl/fitting-mbdpd/"/><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../search_index.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><a class="docs-logo" href="../"><img src="../assets/logo.png" alt="ACEfriction.jl logo"/></a><div class="docs-package-name"><span class="docs-autofit"><a href="../">ACEfriction.jl</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><span class="tocitem">Getting Started</span><ul><li><a class="tocitem" href="../installation/">Installation Guide</a></li><li><a class="tocitem" href="../overview/">Overview</a></li></ul></li><li><span class="tocitem">Workflow Examples</span><ul><li><a class="tocitem" href="../fitting-eft/">Fitting an Electronic Friction Tensor</a></li><li class="is-active"><a class="tocitem" href>Fitting a Dissipative Particle Dynamics Friction Model</a><ul class="internal"><li><a class="tocitem" href="#Background-on-Dissipative-Particle-Dynamics"><span>Background on Dissipative Particle Dynamics</span></a></li><li><a class="tocitem" href="#Momentum-conserving-Friction-Models-in-ACEfriction.jl"><span>Momentum-conserving Friction Models in <code>ACEfriction.jl</code></span></a></li><li><a class="tocitem" href="#Fit-Friction-Model-to-Synthetic-DPD-Friction-Data"><span>Fit Friction Model to Synthetic DPD Friction Data</span></a></li><li><a class="tocitem" href="#Multi-Body-Dissipative-Particle-Dynamics"><span>Multi-Body Dissipative Particle Dynamics</span></a></li></ul></li></ul></li><li><span class="tocitem">Function Manual</span><ul><li><a class="tocitem" href="../function-manual/">Function Manual (@id Function-Manual)</a></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Workflow Examples</a></li><li class="is-active"><a href>Fitting a Dissipative Particle Dynamics Friction Model</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Fitting a Dissipative Particle Dynamics Friction Model</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/ACEsuit/ACEfriction.jl/blob/main/docs/src/fitting-mbdpd.md#" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="Fitting-a-Friction-Tensor-for-Simulation-of-(Multi-Body)-Dissipative-Particle-Dynamics"><a class="docs-heading-anchor" href="#Fitting-a-Friction-Tensor-for-Simulation-of-(Multi-Body)-Dissipative-Particle-Dynamics">Fitting a Friction Tensor for Simulation of (Multi-Body) Dissipative Particle Dynamics</a><a id="Fitting-a-Friction-Tensor-for-Simulation-of-(Multi-Body)-Dissipative-Particle-Dynamics-1"></a><a class="docs-heading-anchor-permalink" href="#Fitting-a-Friction-Tensor-for-Simulation-of-(Multi-Body)-Dissipative-Particle-Dynamics" title="Permalink"></a></h1><p>In this workflow example we demonstrate how <code>ACEfriction.jl</code> can be used to fit a momentum-conserving friction tensor as used in Dissipative Particle Dynamics. </p><h2 id="Background-on-Dissipative-Particle-Dynamics"><a class="docs-heading-anchor" href="#Background-on-Dissipative-Particle-Dynamics">Background on Dissipative Particle Dynamics</a><a id="Background-on-Dissipative-Particle-Dynamics-1"></a><a class="docs-heading-anchor-permalink" href="#Background-on-Dissipative-Particle-Dynamics" title="Permalink"></a></h2><p>Dissipative particle dynamics can be considered as a special version of the Langevin equation @ref, where the friction tensor <span>$\Gamma$</span> is such that the total momentum is conserved, i.e.</p><p class="math-container">\[\frac{d}{dt}\sum_i p_i(t) = {\bf 0}.\]</p><p>In order for this to be the case, the friction tensor must satisfy the constraint</p><p class="math-container">\[\sum_{i}\Gamma_{ij} = {\bf 0}, \text{ for every } j=1,\dots, N_{\rm at}.\]</p><h2 id="Momentum-conserving-Friction-Models-in-ACEfriction.jl"><a class="docs-heading-anchor" href="#Momentum-conserving-Friction-Models-in-ACEfriction.jl">Momentum-conserving Friction Models in <code>ACEfriction.jl</code></a><a id="Momentum-conserving-Friction-Models-in-ACEfriction.jl-1"></a><a class="docs-heading-anchor-permalink" href="#Momentum-conserving-Friction-Models-in-ACEfriction.jl" title="Permalink"></a></h2><p><code>ACEfriction.jl</code> provides utility functions for the construction of momentum-conserving friction models. Namely, the function <a href>mbdpd_matrixmodel</a> yields a pair-wise coupled matrix model with additional symmetries such that resulting friction model satisfies the above constraints. For example, </p><pre><code class="language-julia hljs">m_cov = mbdpd_matrixmodel(EuclideanVector(), [:X], [:X];
    maxorder=1, 
    maxdeg=5,    
    rcutbond = 5.0, 
    rcutenv = 5.0,
    zcutenv = 5.0,
    n_rep = 1, 
    )
fm= FrictionModel((m_cov=m_cov,)); </code></pre><p>results in a momentum-conserving friction model with vector-equivariant blocks in the diffusion matrix. Here, the model is specified for the artifical atom element type <code>:X</code>.</p><h2 id="Fit-Friction-Model-to-Synthetic-DPD-Friction-Data"><a class="docs-heading-anchor" href="#Fit-Friction-Model-to-Synthetic-DPD-Friction-Data">Fit Friction Model to Synthetic DPD Friction Data</a><a id="Fit-Friction-Model-to-Synthetic-DPD-Friction-Data-1"></a><a class="docs-heading-anchor-permalink" href="#Fit-Friction-Model-to-Synthetic-DPD-Friction-Data" title="Permalink"></a></h2><p>The following code loads training and test data comprised of particle configurations and corresponding friction tensors:</p><pre><code class="language-julia hljs">rdata_train = ACEfriction.DataUtils.load_h5fdata(&quot;./examples/data/dpd-train-x.h5&quot;); 
rdata_test = ACEfriction.DataUtils.load_h5fdata(&quot;./examples/data/dpd-train-x.h5&quot;); 

fdata = Dict(&quot;train&quot; =&gt; FrictionData.(rdata_train), 
            &quot;test&quot;=&gt; FrictionData.(rdata_test));
(n_train, n_test) = length(fdata[&quot;train&quot;]), length(fdata[&quot;test&quot;])</code></pre><p>Here the training data is contains friction tensors of 50 configurations each comprised of 64 particles, and the test data contains friction tensors of 10 configurations each comprised of 216 particles. The underlying friction tensors were synthetically generated using the following simple friction model, which is a smooth version of the standard heuristic DPD friction models commonly used in simulations: </p><p class="math-container">\[\Gamma_{ij}( ({\bf r}_k,z_k )_{k=1}^{N_{\rm at}}) := \begin{cases}
\gamma(r_{ij}) \,\hat{\bf r}_{ij} \otimes \hat{\bf r}_{ji}, &amp;i \neq j, \\
-\sum_{k \neq i} \Gamma_{ki}, &amp;i = j,
\end{cases}\]</p><p>where <span>${\bf r}_{ij} := {\bf r}_{j} - {\bf r}_{i}$</span>,  <span>$r_{ij} := \|{\bf r}_{ij}\|_2$</span>, <span>$\hat{\bf r}_{ij} := {\bf r}_{ij}/r_{ij}$</span>, and</p><p class="math-container">\[\gamma(r) := w \exp \left (-\frac{1}{1-(r/r_{\rm cut})^2} \right ), \]</p><p>with weight <span>$w=5.0$</span> and cutoff distance <span>$r_{\rm cut}=5.0$</span>.</p><p>To fit the model we execute exactly the same steps as in the previous example:</p><pre><code class="language-julia hljs">ffm = FluxFrictionModel(params(fm;format=:matrix, joinsites=true))
flux_data = Dict( &quot;train&quot;=&gt; flux_assemble(fdata[&quot;train&quot;], fm, ffm),
                  &quot;test&quot;=&gt; flux_assemble(fdata[&quot;test&quot;], fm, ffm));


loss_traj = Dict(&quot;train&quot;=&gt;Float64[], &quot;test&quot; =&gt; Float64[])
epoch = 0
batchsize = 10
nepochs = 100
opt = Flux.setup(Adam(1E-2, (0.99, 0.999)),ffm)
dloader = DataLoader(flux_data[&quot;train&quot;], batchsize=batchsize, shuffle=true)

for _ in 1:nepochs
    epoch+=1
    @time for d in dloader
        ∂L∂m = Flux.gradient(weighted_l2_loss,ffm, d)[1]
        Flux.update!(opt,ffm, ∂L∂m)       # method for &quot;explicit&quot; gradient
    end
    for tt in [&quot;test&quot;,&quot;train&quot;]
        push!(loss_traj[tt], weighted_l2_loss(ffm,flux_data[tt]))
    end
    println(&quot;Epoch: $epoch, Abs avg Training Loss: $(loss_traj[&quot;train&quot;][end]/n_train)), Test Loss: $(loss_traj[&quot;test&quot;][end]/n_test))&quot;)
end</code></pre><p>After training for 2000 epochs, the resulting model is almost a perfect fit:</p><p><img src="../assets/scatter-equ-cov.jpg" alt="True vs fitted entries of the friction tensor"/>             True vs fitted entries of the friction tensor.</p><h2 id="Multi-Body-Dissipative-Particle-Dynamics"><a class="docs-heading-anchor" href="#Multi-Body-Dissipative-Particle-Dynamics">Multi-Body Dissipative Particle Dynamics</a><a id="Multi-Body-Dissipative-Particle-Dynamics-1"></a><a class="docs-heading-anchor-permalink" href="#Multi-Body-Dissipative-Particle-Dynamics" title="Permalink"></a></h2><p>By specifying <code>maxorder=1</code> in the above construction of the friction model, we restrict the underlying ACE-basis to only incorporate pair-wise interactions. This is fine for the here considered sythentic data as the underlying toy model is in fact based on only pair-wise interactions. However, in more complex systems  the random force and the dissipative force may not decompose to pairwise interactions. To incorporate higher body-order interactions in the friction model, say interactions up to body order 4, we can change the underlying ACE-basis expansion to incorporate correlation terms up to order 3 by setting <code>maxorder=3</code>. </p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../fitting-eft/">« Fitting an Electronic Friction Tensor</a><a class="docs-footer-nextpage" href="../function-manual/">Function Manual (@id Function-Manual) »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.7.0 on <span class="colophon-date" title="Sunday 3 November 2024 15:46">Sunday 3 November 2024</span>. Using Julia version 1.11.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
